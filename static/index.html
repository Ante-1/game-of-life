<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="color-scheme" content="light dark">
    <title>Game of Life</title>
    <link rel="stylesheet" href="css/pico.min.css">
    <link rel="icon" type="image/png" href="/favicon.png">

    <style>
        :root {
            --pico-background-color: #212430 !important;
        }

        #game-board {
            display: grid;
            width: fit-content;
        }

        .cell {
            border: 1px solid black;
            width: 20px;
            height: 20px;
            background-color: grey;
        }

        .populated {
            background-color: chartreuse;
        }

        #start-stop {
            margin-top: 1rem;
            margin-inline: auto;
            display: block;
        }

        .board-background {
            width: fit-content;
        }
    </style>
    <script>
        // @ts-check

        // type defs
        /**
         * @typedef GameBoard
         * @property {number} width
         * @property {number} height
         * @property {number[]} cells
         */

        /**
         * @typedef SavedGameBoard
         * @property {number} id
         * @property {string} name
         * @property {number} width
         * @property {number} height
         * @property {number[]} cells
         */

        const width = 60;
        const height = 40;
        const REFRESH_TIME_MS = 500;
        let savedGameBoards = null;

        document.addEventListener("DOMContentLoaded", () => initBoard());

        async function initBoard() {
            const gameBoard = document.getElementById("game-board");
            const startStopButton = document.getElementById("start-stop");
            const savedBoardsElement = document.getElementById("saved-boards");

            gameBoard.style.gridTemplateColumns = "repeat(" + width + ", 1fr)";
            gameBoard.style.gridTemplateRows = "repeat(" + height + ", 1fr)";

            startStopButton.addEventListener("click", onClickStartStopGame);

            for (let i = 0; i < width * height; i++) {
                const cell = document.createElement("div");
                cell.className = "cell";
                cell.addEventListener("click", onClickCell);
                gameBoard.appendChild(cell);
            }

            const savedBoards = await fetchSavedGameBoards();
            savedGameBoards = savedBoards;
            for (const savedBoard of savedBoards) {
                const row = document.createElement("tr");
                const name = document.createElement("td");
                const size = document.createElement("td");
                const loadButtonCell = document.createElement("td");
                const loadButton = document.createElement("button");
                loadButton.dataset.id = savedBoard.id.toString();
                loadButton.addEventListener("click", loadBoard);

                name.innerHTML = savedBoard.name;
                size.innerHTML = `${savedBoard.width} x ${savedBoard.height}`;
                loadButton.innerHTML = "Load";
                loadButton.className = "small-button";

                savedBoardsElement.appendChild(row);
                row.appendChild(name);
                row.appendChild(size);
                row.appendChild(loadButtonCell);
                loadButtonCell.appendChild(loadButton);
            }
        }

        /**
         * @param {MouseEvent} event
         */
        function loadBoard(event) {
            // todo
        }

        /**
         * @param {MouseEvent} event
         */
        function onClickCell(event) {
            const cell = event.target;
            if (cell.dataset.populated === "1") {
                cell.dataset.populated = "0";
                cell.className = "cell";
            } else {
                cell.dataset.populated = "1";
                cell.className = "cell populated";
            }
        }

        /**
         * @returns {number[]} cells
         */
        function getBoardData() {
            const gameBoard = document.getElementById("game-board");
            const cellElements = gameBoard.children;
            const cells = [];
            for (let cell of cellElements) {
                if (cell.dataset.populated === "1") {
                    cells.push(1);
                } else {
                    cells.push(0);
                }
            }
            return cells;
        }

        /**
         * @param {number[]} cells
         * @returns {Promise<GameBoard>}
         */
        async function fetchNextGameStep(cells) {
            const gameBoard = {
                width,
                height,
                cells
            };
            const body = JSON.stringify(gameBoard);
            const res = await fetch("/computeGameStep", {
                method: "POST",
                body,
                headers: {
                    "Content-Type": "application/json",
                },
            });
            return await res.json();
        }

        /**
         * @param {number[]} cells
         */
        function renderBoard(cells) {
            const gameBoard = document.getElementById("game-board");
            const cellElements = gameBoard.children;
            for (let i = 0; i < cellElements.length; i++) {
                if (cells[i] === 1) {
                    cellElements[i].dataset.populated = "1";
                    cellElements[i].className = "cell populated";
                } else {
                    cellElements[i].dataset.populated = "0";
                    cellElements[i].className = "cell";
                }
            }
        }

        async function progress() {
            const boardData = getBoardData();
            const nextBoard = await fetchNextGameStep(boardData);
            renderBoard(nextBoard.cells);
        }

        async function onClickStartStopGame() {
            const gameBoard = document.getElementById("game-board");

            if (gameBoard.dataset.running === "true") {
                gameBoard.dataset.running = "false";
            } else {
                gameBoard.dataset.running = "true";
            }

            while (gameBoard.dataset.running === "true") {
                const start = Date.now();
                await progress();
                const end = Date.now();
                const elapsedTime = end - start;
                if (elapsedTime < REFRESH_TIME_MS) {
                    await wait(REFRESH_TIME_MS - elapsedTime);
                }
            }
        }

        /**
         * @returns {Promise<SavedGameBoard[]>}
         */
        async function fetchSavedGameBoards() {
            const res = await fetch("/gameBoards");
            return await res.json();
        }

        /**
         * @param {number} ms time to wait in milliseconds
         * @returns {Promise<void>}
         */
        const wait = ms => new Promise(resolve => setTimeout(resolve, ms));
    </script>
</head>
<body>
<main class="container">
    <section>
        <h1>Game of Life</h1>
        <article class="board-background">
            <div id="game-board"></div>
            <button id="start-stop">Start / Stop</button>
        </article>
    </section>
    <section>
        <h2>Saved Game Boards</h2>
        <table id="saved-boards">
        </table>
    </section>
</main>
</body>
</html>