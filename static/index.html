<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Game of Life</title>
</head>
<style>
    #game-board {
        display: grid;
        width: fit-content;
    }

    .cell {
        border: 1px solid black;
        width: 20px;
        height: 20px;
        background-color: grey;
    }

    .populated {
        background-color: chartreuse;
    }
</style>
<script>
    const width = 85;
    const height = 45;
    const REFRESH_TIME_MS = 500;

    document.addEventListener("DOMContentLoaded", () => initBoard());

    function initBoard() {
        const gameBoard = document.getElementById("game-board");
        const startStopButton = document.getElementById("start-stop");
        gameBoard.style.gridTemplateColumns = "repeat(" + width + ", 1fr)";
        gameBoard.style.gridTemplateRows = "repeat(" + height + ", 1fr)";

        startStopButton.addEventListener("click", onClickStartStopGame);

        for (let i = 0; i < width * height; i++) {
            const cell = document.createElement("div");
            cell.className = "cell";
            cell.addEventListener("click", onClickCell);
            gameBoard.appendChild(cell);
        }
    }

    function onClickCell(event) {
        const cell = event.target;
        if (cell.dataset.populated === "1") {
            cell.dataset.populated = "0";
            cell.className = "cell";
        } else {
            cell.dataset.populated = "1";
            cell.className = "cell populated";
        }
    }

    function getBoardData() {
        const gameBoard = document.getElementById("game-board");
        const cellElements = gameBoard.children;
        const cells = [];
        for (let cell of cellElements) {
            if (cell.dataset.populated === "1") {
                cells.push(1);
            } else {
                cells.push(0);
            }
        }
        return cells;
    }

    async function fetchNextGameStep(cells) {
        const gameBoard = {
            width,
            height,
            cells
        };
        const body = JSON.stringify(gameBoard);
        const res = await fetch("/computeGameStep", {
            method: "POST",
            body,
            headers: {
                "Content-Type": "application/json",
            },
        });
        return await res.json();
    }

    function renderBoard(cells) {
        const gameBoard = document.getElementById("game-board");
        const cellElements = gameBoard.children;
        for (let i = 0; i < cellElements.length; i++) {
            if (cells[i] === 1) {
                cellElements[i].dataset.populated = "1";
                cellElements[i].className = "cell populated";
            } else {
                cellElements[i].dataset.populated = "0";
                cellElements[i].className = "cell";
            }
        }
    }

    async function progress() {
        const boardData = getBoardData();
        const nextBoard = await fetchNextGameStep(boardData);
        renderBoard(nextBoard.cells);
    }

    async function onClickStartStopGame() {
        const gameBoard = document.getElementById("game-board");

        if (gameBoard.dataset.running === "true") {
            gameBoard.dataset.running = "false";
        } else {
            gameBoard.dataset.running = "true";
        }

        while (gameBoard.dataset.running === "true") {
            const start = Date.now();
            await progress();
            const end = Date.now();
            const elapsedTime = end - start;
            if (elapsedTime < REFRESH_TIME_MS) {
                await wait(REFRESH_TIME_MS - elapsedTime);
            }
        }
    }

    const wait = ms => new Promise(resolve => setTimeout(resolve, ms));
</script>
<body>
<div id="game-board">
</div>
<button id="start-stop">Start / Stop</button>
</body>
</html>